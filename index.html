<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Data Wall</title>

  <style>
    :root{
      --bg:#0b0d10;
      --fg:#e9eef5;
      --muted:#9aa7b6;
      --card:rgba(255,255,255,0.06);
      --card-border:rgba(255,255,255,0.10);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 30% 20%, rgba(74,144,226,0.14), transparent 55%),
        radial-gradient(1000px 700px at 80% 70%, rgba(255,59,92,0.10), transparent 60%),
        var(--bg);
      color:var(--fg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      overflow:hidden;
    }

    /* Leave room for the fixed CAA banner */
    .frame{
      height:100%;
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:14px;
      padding:18px 22px 96px;
    }

    header, footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:10px 14px;
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:14px;
      backdrop-filter: blur(8px);
    }

    header .left{
      display:flex;
      align-items:baseline;
      gap:12px;
      min-width:0;
    }

    header h1{
      font-size:18px;
      margin:0;
      white-space:nowrap;
    }

    header .sub{
      font-size:13px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    header .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--card-border);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(0,0,0,0.2);
      white-space:nowrap;
    }

    .stage{
      position:relative;
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:18px;
      overflow:hidden;
      min-height:0;
      padding:16px;
    }

    .grid{
      height:100%;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:16px;
      min-height:0;
    }

    .panel{
      position:relative;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      overflow:hidden;
      min-height:0;
    }

    /* --- AirData iframe scaling wrapper --- */
    .cert-wrap{
      position:absolute;
      inset:0;
      overflow:hidden;
      background:rgba(0,0,0,0.15);
      --scale: 0.46;
      --x: 0px;
      --y: 0px;
    }

    .cert-iframe{
      position:absolute;
      top:0;
      left:0;
      width:calc(100% / var(--scale));
      height:calc(100% / var(--scale));
      transform: scale(var(--scale)) translate(var(--x), var(--y));
      transform-origin: top left;
      border:0;
      background:#fff;
    }

    /* Display-only mode */
    .display-only .cert-iframe,
    .display-only #yt-player iframe{
      pointer-events:none;
    }

    /* --- Media panel --- */
    .media-header{
      position:absolute;
      top:10px;
      left:12px;
      right:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      z-index:3;
    }

    .media-title{
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }

    .media-bg{
      position:absolute;
      inset:0;
      background-position:center;
      background-size:cover;
      filter: blur(18px);
      transform: scale(1.08);
      opacity:0.55;
      z-index:1;
    }

    .media-video{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      padding:24px;
      z-index:2;
    }

    /* The API injects an iframe inside this */
    #yt-player{
      width:100%;
      height:100%;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
      background: rgba(0,0,0,0.35);
    }
    #yt-player iframe{
      width:100%;
      height:100%;
      border:0;
      border-radius:12px;
    }

    footer .hint{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .progress{
      width:240px;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,0.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.10);
    }

    .progress > div{
      height:100%;
      width:0%;
      background:rgba(233,238,245,0.85);
      transition:width 200ms linear;
    }

    @media (max-width:980px){
      .grid{ grid-template-columns:1fr; }
      .frame{ padding-bottom: 112px; }
    }

    /* ===============================
       CAA Operational Authority Bar
       =============================== */
    .CAA-BANNER{
      position:fixed;
      bottom:14px;
      left:14px;
      right:14px;
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;

      background:rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:10px 16px;
      z-index:999;
    }

    .CAA-LEFT{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:0;
    }

    .CAA-LOGO{
      height:34px;
      width:auto;
      filter:brightness(1.05);
    }

    .CAA-TEXT{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .CAA-TITLE{
      font-size:13px;
      font-weight:600;
      letter-spacing:0.3px;
    }

    .CAA-SUB{
      font-size:11px;
      color:rgba(255,255,255,0.7);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .CAA-RIGHT{
      display:flex;
      align-items:center;
    }

    .CAA-PILL{
      font-size:12px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.35);
      color:rgba(255,255,255,0.85);
      white-space:nowrap;
    }
  </style>
</head>

<body class="display-only">
  <div class="frame">

    <header>
      <div class="left">
        <h1>Flight Data Wall</h1>
        <div class="sub">AirData Certificate + Media Loop</div>
      </div>
      <div class="right">
        <div class="pill" id="refreshPill">Next stats refresh: —</div>
      </div>
    </header>

    <main class="stage">
      <div class="grid">

        <!-- AirData Certificate -->
        <section class="panel">
          <div class="cert-wrap" id="certWrap">
            <iframe
              id="certFrame"
              class="cert-iframe"
              loading="eager"
              referrerpolicy="no-referrer"
              title="AirData Certificate"
            ></iframe>
          </div>
        </section>

        <!-- Media panel -->
        <section class="panel">
          <div class="media-header">
            <div class="media-title" id="mediaTitle">Secur-IT UAV Demo Loop</div>
          </div>

          <div class="media-bg" id="mediaBg"></div>

          <div class="media-video">
            <div id="yt-player" aria-label="YouTube playlist player"></div>
          </div>
        </section>

      </div>
    </main>

    <footer>
      <div class="hint">Stats refresh automatically every hour. Press [ or ] to nudge cert scale (session only).</div>
      <div class="progress"><div id="bar"></div></div>
    </footer>

  </div>

  <!-- CAA Operational Authority Banner -->
  <div class="CAA-BANNER" role="note" aria-label="CAA Operational Authorisation banner">
    <div class="CAA-LEFT">
      <img
        src="https://register-drones.caa.co.uk/assets/images/caa_logo.png"
        alt="UK Civil Aviation Authority"
        class="CAA-LOGO"
      />
      <div class="CAA-TEXT">
        <div class="CAA-TITLE">CAA Operational Authorisation Granted</div>
        <div class="CAA-SUB">Approved UAS Operator · Advanced operations authorised under defined procedures</div>
      </div>
    </div>
    <div class="CAA-RIGHT">
      <span class="CAA-PILL">Operator ID: <strong>GBR-OP-6PN55Z8L5VTQ</strong></span>
    </div>
  </div>

  <script>
    // =======================
    // CONFIG
    // =======================
    const CERT_URL = "https://certificates.airdata.com/BmNedR";

    // Video IDs (duplicate removed) - plays in order, loops forever
    const VIDEO_PLAYLIST = [
   "9P-4ax971wo",
      "-HFS6P-FBOc",
      "jZ3bDjjdXNc",
      "UuNGXrXry4k",
      "OwUwgpqgcMA",
      "NMoUBGDDIfM"
    ];

    const MEDIA_TITLE = "Secur-IT UAV Demo Loop";

    const REFRESH_EVERY_MS = 60 * 60 * 1000; // 1 hour
    const DEFAULT_SCALE = 0.46;

    const certFrame = document.getElementById("certFrame");
    const certWrap  = document.getElementById("certWrap");
    const refreshPill = document.getElementById("refreshPill");
    const bar = document.getElementById("bar");

    const mediaBg   = document.getElementById("mediaBg");
    const mediaTitle = document.getElementById("mediaTitle");

    // =======================
    // AirData certificate
    // =======================
    function cacheBust(url){
      const u = new URL(url);
      u.searchParams.set("_ts", Date.now());
      return u.toString();
    }

    function applyDefaultScale(){
      // Force the default every time (no persistence)
      certWrap.style.setProperty("--scale", String(DEFAULT_SCALE));
    }

    function loadCertificate(){
      certFrame.src = cacheBust(CERT_URL);
    }

    // =======================
    // Refresh timer (hourly)
    // =======================
    function startRefreshTimer(){
      const start = Date.now();
      const next = new Date(start + REFRESH_EVERY_MS);

      refreshPill.textContent =
        `Next stats refresh: ${next.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" })}`;

      if (window._progressTimer) clearInterval(window._progressTimer);
      window._progressTimer = setInterval(() => {
        const pct = Math.min(100, ((Date.now() - start) / REFRESH_EVERY_MS) * 100);
        bar.style.width = pct.toFixed(2) + "%";
      }, 500);

      if (window._refreshTimer) clearTimeout(window._refreshTimer);
      window._refreshTimer = setTimeout(() => {
        loadCertificate();
        bar.style.width = "0%";
        startRefreshTimer();
      }, REFRESH_EVERY_MS);
    }

    // =======================
    // YouTube Playlist Player (IFrame API)
    // =======================
    let ytPlayer;
    let currentIndex = 0;

    function initYouTubeBackground(){
      if (mediaTitle) mediaTitle.textContent = MEDIA_TITLE;
      if (mediaBg && VIDEO_PLAYLIST.length) {
        mediaBg.style.backgroundImage =
          `url("https://i.ytimg.com/vi/${VIDEO_PLAYLIST[0]}/hqdefault.jpg")`;
      }
    }

    // Called by https://www.youtube.com/iframe_api
    function onYouTubeIframeAPIReady() {
      ytPlayer = new YT.Player("yt-player", {
        width: "100%",
        height: "100%",
        videoId: VIDEO_PLAYLIST[0],
        playerVars: {
          autoplay: 1,
          controls: 0,
          mute: 1,
          rel: 0,
          modestbranding: 1,
          playsinline: 1,
          fs: 0,
          iv_load_policy: 3
        },
        events: {
          onReady: (e) => {
            try { e.target.mute(); } catch {}
            e.target.playVideo();
          },
          onStateChange: (e) => {
            // Advance on end, loop to start
            if (e.data === YT.PlayerState.ENDED) {
              currentIndex = (currentIndex + 1) % VIDEO_PLAYLIST.length;
              ytPlayer.loadVideoById(VIDEO_PLAYLIST[currentIndex]);
            }
          },
          onError: () => {
            // Skip forward if a video is unavailable
            setTimeout(() => {
              currentIndex = (currentIndex + 1) % VIDEO_PLAYLIST.length;
              ytPlayer.loadVideoById(VIDEO_PLAYLIST[currentIndex]);
            }, 1500);
          }
        }
      });
    }

    // =======================
    // Init
    // =======================
    applyDefaultScale();
    loadCertificate();
    initYouTubeBackground();
    startRefreshTimer();

    // Hidden scale controls still available (session-only)
    window.addEventListener("keydown", (e) => {
      if (e.key !== "[" && e.key !== "]") return;

      const current = parseFloat(getComputedStyle(certWrap).getPropertyValue("--scale")) || DEFAULT_SCALE;
      const next = (e.key === "[") ? (current - 0.02) : (current + 0.02);
      const clamped = Math.min(1.20, Math.max(0.40, next));
      certWrap.style.setProperty("--scale", clamped.toFixed(2));
    });
  </script>

  <!-- YouTube IFrame Player API (loads and then calls onYouTubeIframeAPIReady) -->
  <script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
