<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Data Wall</title>

  <style>
    :root{
      --bg:#0b0d10;
      --fg:#e9eef5;
      --muted:#9aa7b6;
      --card:rgba(255,255,255,0.06);
      --card-border:rgba(255,255,255,0.10);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 30% 20%, rgba(74,144,226,0.14), transparent 55%),
        radial-gradient(1000px 700px at 80% 70%, rgba(255,59,92,0.10), transparent 60%),
        var(--bg);
      color:var(--fg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      overflow:hidden;
    }

    .frame{
      height:100%;
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:14px;
      padding:18px 22px;
    }

    header, footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:10px 14px;
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:14px;
      backdrop-filter: blur(8px);
    }

    header .left{
      display:flex;
      align-items:baseline;
      gap:12px;
      min-width:0;
    }

    header h1{
      font-size:18px;
      margin:0;
      white-space:nowrap;
    }

    header .sub{
      font-size:13px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    header .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--card-border);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(0,0,0,0.2);
      white-space:nowrap;
    }

    .stage{
      position:relative;
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:18px;
      overflow:hidden;
      min-height:0;
      padding:16px;
    }

    .grid{
      height:100%;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:16px;
      min-height:0;
    }

    .panel{
      position:relative;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      overflow:hidden;
      min-height:0;
    }

    /* --- AirData iframe scaling wrapper --- */
    .cert-wrap{
      position:absolute;
      inset:0;
      overflow:hidden;
      background:rgba(0,0,0,0.15);
      --scale: 0.56;
      --x: 0px;
      --y: 0px;
    }

    .cert-iframe{
      position:absolute;
      top:0;
      left:0;
      width:calc(100% / var(--scale));
      height:calc(100% / var(--scale));
      transform: scale(var(--scale)) translate(var(--x), var(--y));
      transform-origin: top left;
      border:0;
      background:#fff;
    }

    /* Display-only mode */
    .display-only .cert-iframe,
    .display-only .youtube-iframe{
      pointer-events:none;
    }

    /* --- Media panel --- */
    .media-header{
      position:absolute;
      top:10px;
      left:12px;
      right:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      z-index:3;
    }

    .media-title{
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }

    .media-bg{
      position:absolute;
      inset:0;
      background-position:center;
      background-size:cover;
      filter: blur(18px);
      transform: scale(1.08);
      opacity:0.55;
      z-index:1;
    }

    .media-video{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      padding:24px;
      z-index:2;
    }

    .media-video .youtube-iframe{
      width:100%;
      aspect-ratio:16 / 9;
      border-radius:12px;
      border:0;
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
      background: rgba(0,0,0,0.35);
    }

    footer .hint{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .progress{
      width:240px;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,0.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.10);
    }

    .progress > div{
      height:100%;
      width:0%;
      background:rgba(233,238,245,0.85);
      transition:width 200ms linear;
    }

    @media (max-width:980px){
      .grid{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body class="display-only">
  <div class="frame">

    <header>
      <div class="left">
        <h1>Flight Data Wall</h1>
        <div class="sub">AirData Certificate + Media Loop</div>
      </div>
      <div class="right">
        <div class="pill" id="refreshPill">Next stats refresh: â€”</div>
      </div>
    </header>

    <main class="stage">
      <div class="grid">

        <!-- AirData Certificate -->
        <section class="panel">
          <div class="cert-wrap" id="certWrap">
            <iframe
              id="certFrame"
              class="cert-iframe"
              loading="eager"
              referrerpolicy="no-referrer"
              title="AirData Certificate"
            ></iframe>
          </div>
        </section>

        <!-- Media panel -->
        <section class="panel">
          <div class="media-header">
            <div class="media-title" id="mediaTitle">Secur-IT UAV Demo Loop</div>
          </div>

          <div class="media-bg" id="mediaBg"></div>

          <div class="media-video">
            <iframe
              id="ytFrame"
              class="youtube-iframe"
              title="YouTube Demo"
              allow="autoplay; encrypted-media; picture-in-picture"
              loading="eager"
            ></iframe>
          </div>
        </section>

      </div>
    </main>

    <footer>
      <div class="hint">Stats refresh automatically every hour. Press [ or ] to nudge cert scale (session only).</div>
      <div class="progress"><div id="bar"></div></div>
    </footer>

  </div>

  <script>
    // =======================
    // CONFIG
    // =======================
    const CERT_URL = "https://certificates.airdata.com/BmNedR";
    const YOUTUBE_VIDEO_ID = "pR7HFtJjN8g";
    const MEDIA_TITLE = "Secur-IT UAV Demo Loop";

    const REFRESH_EVERY_MS = 60 * 60 * 1000; // 1 hour
    const DEFAULT_SCALE = 0.46;

    const certFrame = document.getElementById("certFrame");
    const certWrap  = document.getElementById("certWrap");
    const ytFrame   = document.getElementById("ytFrame");
    const mediaBg   = document.getElementById("mediaBg");
    const mediaTitle = document.getElementById("mediaTitle");
    const refreshPill = document.getElementById("refreshPill");
    const bar = document.getElementById("bar");

    function cacheBust(url){
      const u = new URL(url);
      u.searchParams.set("_ts", Date.now());
      return u.toString();
    }

    function applyDefaultScale(){
      // Force the default every time (no localStorage persistence)
      certWrap.style.setProperty("--scale", String(DEFAULT_SCALE));
    }

    function loadCertificate(){
      certFrame.src = cacheBust(CERT_URL);
    }

    function loadYouTube(){
      mediaTitle.textContent = MEDIA_TITLE;

      mediaBg.style.backgroundImage =
        `url("https://i.ytimg.com/vi/${YOUTUBE_VIDEO_ID}/hqdefault.jpg")`;

      // YouTube embed reliability fix:
      // - use youtube-nocookie
      // - provide explicit origin (file:// has origin "null")
      const origin = (location.origin === "null") ? "https://localhost" : location.origin;

      ytFrame.src =
        `https://www.youtube-nocookie.com/embed/${YOUTUBE_VIDEO_ID}` +
        `?autoplay=1&mute=1&controls=0&rel=0&playsinline=1` +
        `&loop=1&playlist=${YOUTUBE_VIDEO_ID}` +
        `&origin=${encodeURIComponent(origin)}`;
    }

    function startRefreshTimer(){
      const start = Date.now();
      const next = new Date(start + REFRESH_EVERY_MS);
      refreshPill.textContent =
        `Next stats refresh: ${next.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" })}`;

      if (window._progressTimer) clearInterval(window._progressTimer);
      window._progressTimer = setInterval(() => {
        const pct = Math.min(100, ((Date.now() - start) / REFRESH_EVERY_MS) * 100);
        bar.style.width = pct.toFixed(2) + "%";
      }, 500);

      if (window._refreshTimer) clearTimeout(window._refreshTimer);
      window._refreshTimer = setTimeout(() => {
        loadCertificate();
        bar.style.width = "0%";
        startRefreshTimer();
      }, REFRESH_EVERY_MS);
    }

    // Init
    applyDefaultScale();
    loadCertificate();
    loadYouTube();
    startRefreshTimer();

    // Hidden scale controls still available (session-only)
    window.addEventListener("keydown", (e) => {
      if (e.key !== "[" && e.key !== "]") return;

      const current = parseFloat(getComputedStyle(certWrap).getPropertyValue("--scale")) || DEFAULT_SCALE;
      const next = (e.key === "[") ? (current - 0.02) : (current + 0.02);
      const clamped = Math.min(1.20, Math.max(0.40, next));
      certWrap.style.setProperty("--scale", clamped.toFixed(2));
    });
  </script>
</body>
</html>
